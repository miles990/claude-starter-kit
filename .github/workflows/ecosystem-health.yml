# ============================================================================
# Ecosystem Health Check
# ============================================================================
# 每日檢查生態系統各組件版本和狀態
#
# 觸發方式：
#   1. 每日 UTC 00:00 自動執行
#   2. 手動觸發 (workflow_dispatch)
# ============================================================================

name: Ecosystem Health Check

on:
  schedule:
    # 每天 UTC 00:00 (台灣時間 08:00)
    - cron: '0 0 * * *'

  workflow_dispatch:
    inputs:
      verbose:
        description: 'Show detailed output'
        required: false
        type: boolean
        default: false

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check ecosystem.json
        id: ecosystem
        run: |
          echo "## Ecosystem Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # 讀取 ecosystem.json
          if [ -f "ecosystem.json" ]; then
            echo "Reading ecosystem.json..."

            # 使用 jq 解析（如果有）或 node
            node -e "
              const eco = require('./ecosystem.json');
              console.log('### Components');
              console.log('');
              console.log('| Component | Min Version | Recommended |');
              console.log('|-----------|-------------|-------------|');
              for (const [name, info] of Object.entries(eco.components)) {
                console.log(\`| \${name} | \${info.min_version} | \${info.recommended} |\`);
              }
            " >> $GITHUB_STEP_SUMMARY

            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "ecosystem.json not found!" >> $GITHUB_STEP_SUMMARY
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Check Memory Structure
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Memory System" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d ".claude/memory" ]; then
            echo "| Directory | Files |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY

            for dir in learnings decisions failures patterns strategies discoveries; do
              if [ -d ".claude/memory/$dir" ]; then
                count=$(find .claude/memory/$dir -name "*.md" 2>/dev/null | wc -l)
                echo "| $dir | $count |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "Memory directory not found!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check skillpkg
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Skills" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # 檢查本地安裝的 skills
          if [ -d ".skillpkg/skills" ]; then
            echo "| Skill | Version |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|---------|" >> $GITHUB_STEP_SUMMARY

            for skill_dir in .skillpkg/skills/*/; do
              if [ -f "$skill_dir/SKILL.md" ]; then
                name=$(basename "$skill_dir")
                version=$(grep -m1 "^version:" "$skill_dir/SKILL.md" | cut -d: -f2 | tr -d ' ' || echo "unknown")
                echo "| $name | $version |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "No local skills installed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Last checked: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
